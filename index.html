<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ระบบการจัดการการผ่อนชำระ </title>
  
  <!-- Font & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

  <style>
    /* --- Styles & Variables --- */
    :root {
      --bg-color: #FAFAF5; 
      --text-color: #333333;
      --card-bg: #FFFFFF;
      --primary-color: #4A6FA5;
      --success-color: #4CAF50;
      --danger-color: #E57373;
      --border-radius: 12px;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Sarabun', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      margin: 0; padding: 20px; font-size: 18px; line-height: 1.6;
    }

    .container { max-width: 1000px; margin: 0 auto; padding-bottom: 50px; }
    h1, h2, h3 { color: #2c3e50; margin-top: 0; }
    h2 { font-size: 1.5rem; border-bottom: 2px solid #ddd; padding-bottom: 10px; margin-bottom: 20px; }
    
    /* Dashboard */
    .dashboard { display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 30px; }
    @media (min-width: 768px) { .dashboard { grid-template-columns: 1fr 1fr; body { font-size: 20px; } } }
    
    .stat-card { background: var(--card-bg); padding: 25px; border-radius: var(--border-radius); box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; border: 1px solid #e0e0e0; }
    .stat-title { font-size: 1.1rem; color: #666; }
    .stat-value { font-size: 2.5rem; font-weight: 700; color: var(--primary-color); margin: 10px 0; }
    .stat-unit { font-size: 1rem; color: #888; }
    
    /* Form */
    .form-container { background: var(--card-bg); padding: 25px; border-radius: var(--border-radius); box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 40px; }
    .form-group { margin-bottom: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; }
    input, select { width: 100%; padding: 15px; font-size: 1.1rem; border: 2px solid #ccc; border-radius: 8px; font-family: 'Sarabun', sans-serif; background: #fff; }
    input:focus { border-color: var(--primary-color); outline: none; }
    
    button { cursor: pointer; font-family: 'Sarabun', sans-serif; border: none; transition: 0.2s; }
    .btn-main { width: 100%; background-color: var(--primary-color); color: white; font-size: 1.2rem; font-weight: 600; padding: 18px; border-radius: 8px; box-shadow: 0 4px 0 #34517b; }
    .btn-main:active { transform: translateY(2px); box-shadow: 0 2px 0 #34517b; }

    /* List */
    #installmentList { display: grid; grid-template-columns: 1fr; gap: 20px; }
    @media (min-width: 600px) { #installmentList { grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); } }
    
    .card { background: var(--card-bg); padding: 20px; border-radius: var(--border-radius); box-shadow: 0 2px 5px rgba(0,0,0,0.05); border-left: 8px solid var(--primary-color); position: relative; }
    .card.paid-off { border-left-color: var(--success-color); background-color: #f9fff9; opacity: 0.9; }
    .card-header { font-size: 1.3rem; font-weight: 700; margin-bottom: 5px; }
    .card-sub { color: #666; margin-bottom: 15px; font-size: 1rem; }
    
    .card-stat { display: flex; justify-content: space-between; align-items: center; background: #f0f4f8; padding: 10px 15px; border-radius: 8px; margin-bottom: 15px; }
    .remaining-badge { font-size: 1.2rem; font-weight: 700; color: #d32f2f; }
    .paid-badge { color: var(--success-color); font-weight: bold; }
    
    .btn-pay { width: 100%; background-color: var(--success-color); color: white; padding: 15px; font-size: 1.1rem; border-radius: 8px; margin-bottom: 10px; font-weight: 600; }
    .btn-delete { width: 100%; background: transparent; border: 2px solid #ddd; color: #888; padding: 10px; border-radius: 8px; font-size: 1rem; }
    .btn-delete:hover { border-color: var(--danger-color); color: var(--danger-color); background: #fff5f5; }

    /* Loading */
    #loading { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.9); display: flex; justify-content: center; align-items: center; font-size: 1.5rem; color: var(--primary-color); z-index: 999; display: none; flex-direction: column; }
    .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-color); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 15px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <!-- Loading Screen -->
  <div id="loading">
    <div class="spinner"></div>
    <div id="loading-text">กำลังโหลดข้อมูล...</div>
  </div>

  <div class="container">
    <div style="text-align: center; margin-bottom: 20px;">
        <h1>ระบบการจัดการการผ่อนชำระ </h1>
    </div>

    <!-- Dashboard -->
    <div class="dashboard">
      <div class="stat-card">
        <div class="stat-title">ต้องจ่ายเดือนนี้</div>
        <div class="stat-value" id="totalMonthly">0</div>
        <div class="stat-unit">บาท</div>
      </div>
      <div class="stat-card">
        <div class="stat-title">หนี้คงเหลือทั้งหมด</div>
        <div class="stat-value" id="totalDebt" style="color: #d32f2f;">0</div>
        <div class="stat-unit">บาท</div>
      </div>
    </div>

    <!-- Form -->
    <div class="form-container">
      <h2><i class="fas fa-plus-circle"></i> เพิ่มรายการใหม่</h2>
      <form id="addForm" onsubmit="handleFormSubmit(event)">
        <div class="form-group">
          <label>ชื่อรายการ</label>
          <input type="text" name="itemName" required placeholder="เช่น ตู้เย็น">
        </div>
        <div class="form-group">
          <label>ธนาคาร</label>
          <select name="bankName" required>
            <option value="" disabled selected>เลือกธนาคาร...</option>
            <option value="กสิกร">กสิกร (KBank)</option>
            <option value="ไทยพาณิชย์">ไทยพาณิชย์ (SCB)</option>
            <option value="กรุงเทพ">กรุงเทพ (BBL)</option>
            <option value="กรุงศรี">กรุงศรี (Krungsri)</option>
            <option value="KTC">KTC</option>
            <option value="ttb">ttb</option>
            <option value="UOB">UOB / Citi</option>
            <option value="First Choice">First Choice</option>
            <option value="AEON">AEON</option>
            <option value="อื่นๆ">อื่นๆ</option>
          </select>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
          <div class="form-group">
            <label>ผ่อนงวดละ</label>
            <input type="number" name="monthlyAmount" required min="1">
          </div>
          <div class="form-group">
            <label>เหลือ (งวด)</label>
            <input type="number" name="remainingMonths" required min="1">
          </div>
        </div>
        <button type="submit" class="btn-main">บันทึกรายการ</button>
      </form>
    </div>

    <!-- List -->
    <div id="installmentList"></div>
  </div>

  <script>
    /* ======================================================
       ตั้งค่าการเชื่อมต่อ (อัปเดตเรียบร้อย)
       ====================================================== */
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbx8S1yg93r80fM2l2ZCH_Jwk1ABEmKYYdDRX8Xn1NM3EGVUo2oCrMqqXnx1wEGjK84/exec"; 
    
    // --- เริ่มต้นทำงาน ---
    window.onload = function() {
      if (!WEB_APP_URL) {
        alert("ไม่พบ URL ของ Google Apps Script");
        return;
      }
      loadData();
    };

    function showLoading(show, text="กำลังประมวลผล...") {
      const el = document.getElementById('loading');
      document.getElementById('loading-text').innerText = text;
      el.style.display = show ? 'flex' : 'none';
    }

    // --- เชื่อมต่อ API ---
    // ใช้เทคนิค text/plain เพื่อเลี่ยง CORS preflight
    async function callAPI(action, payload = {}) {
      const url = `${WEB_APP_URL}`;
      
      // ถ้าเป็นการอ่านข้อมูล ใช้ GET
      if (action === 'read') {
        const response = await fetch(`${url}?action=read`);
        return await response.json();
      } 
      
      // ถ้าเป็นการแก้ไขข้อมูล ใช้ POST
      else {
        payload.action = action;
        const response = await fetch(url, {
          method: 'POST',
          body: JSON.stringify(payload)
        });
        return await response.json();
      }
    }

    // --- โหลดข้อมูล ---
    async function loadData() {
      showLoading(true, "กำลังดึงข้อมูลจาก Sheet...");
      try {
        const res = await callAPI('read');
        if (res.status === 'success') {
          renderPage(res.data);
        } else {
          console.error(res);
          alert('เกิดข้อผิดพลาด: ' + (res.message || 'Unknown error'));
        }
      } catch (err) {
        console.error(err);
        alert('เชื่อมต่อไม่สำเร็จ กรุณาตรวจสอบ URL หรือ Internet');
      }
      showLoading(false);
    }

    // --- แสดงผล ---
    function renderPage(data) {
      const listContainer = document.getElementById('installmentList');
      listContainer.innerHTML = '';
      
      let totalMonthly = 0;
      let totalDebt = 0;

      if (!data || data.length === 0) {
        listContainer.innerHTML = '<div style="text-align:center; color:#888;">ยังไม่มีรายการ</div>';
        updateDash(0,0);
        return;
      }

      data.forEach(item => {
        if (item.remaining_months > 0) {
          totalMonthly += Number(item.monthly_amount);
          totalDebt += (Number(item.monthly_amount) * Number(item.remaining_months));
        }

        const isPaid = item.remaining_months <= 0;
        const card = document.createElement('div');
        card.className = `card ${isPaid ? 'paid-off' : ''}`;
        card.innerHTML = `
          <div class="card-header">${item.item_name}</div>
          <div class="card-sub">${item.bank_name}</div>
          <div class="card-stat">
            <div><small>งวดละ</small><br><strong>${Number(item.monthly_amount).toLocaleString()}</strong></div>
            <div style="text-align:right;"><small>เหลือ</small><br>${isPaid ? '<span class="paid-badge">หมดแล้ว</span>' : `<span class="remaining-badge">${item.remaining_months}</span> งวด`}</div>
          </div>
          ${!isPaid ? `<button class="btn-pay" onclick="doAction('pay', '${item.id}')">จ่ายงวดนี้</button>` : ''}
          <button class="btn-delete" onclick="doAction('delete', '${item.id}')">ลบรายการ</button>
        `;
        listContainer.appendChild(card);
      });
      updateDash(totalMonthly, totalDebt);
    }

    function updateDash(m, d) {
      document.getElementById('totalMonthly').innerText = m.toLocaleString();
      document.getElementById('totalDebt').innerText = d.toLocaleString();
    }

    // --- Action (Add/Pay/Delete) ---
    async function handleFormSubmit(e) {
      e.preventDefault();
      const form = e.target;
      const data = {
        itemName: form.itemName.value,
        bankName: form.bankName.value,
        monthlyAmount: form.monthlyAmount.value,
        remainingMonths: form.remainingMonths.value
      };

      if (confirm('ยืนยันบันทึกรายการ?')) {
        showLoading(true, "กำลังบันทึกลง Sheet...");
        await callAPI('add', data);
        form.reset();
        await loadData();
      }
    }

    async function doAction(action, id) {
      let msg = action === 'pay' ? 'ยืนยันจ่ายงวดนี้?' : 'ยืนยันลบรายการนี้?';
      if (confirm(msg)) {
        showLoading(true, "กำลังอัปเดต...");
        await callAPI(action, { id: id });
        await loadData();
      }
    }
  </script>
</body>
</html>
